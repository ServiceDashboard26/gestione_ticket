<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gestione Ticket - Benvenuto</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 650px; margin: auto; }
        .header { border-bottom: 2px solid #28a745; margin-bottom: 20px; padding-bottom: 10px; }
        .data-label { font-weight: bold; color: #666; width: 140px; display: inline-block; }
        .data-value { color: #28a745; font-weight: bold; font-size: 1.1em; }
        .timestamp-info { font-size: 0.9em; color: #888; margin-top: 10px; font-style: italic; }
        textarea { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ccc; border-radius: 6px; resize: none; box-sizing: border-box; }
        button { width: 100%; background: #28a745; color: white; border: none; padding: 15px; margin-top: 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; }
        button:hover { background: #218838; }
        
        /* Tabella Storico */
        table { width: 100%; border-collapse: collapse; margin-top: 40px; background: white; font-size: 13px; }
        th { background: #28a745; color: white; padding: 12px; text-align: left; border: 1px solid #218838; }
        td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .time-cell { font-family: monospace; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Benvenuto, <span id="c_header">Cliente</span></h2>
        <div id="access-time" class="timestamp-info">Accesso effettuato il: --/--/---- ore --:--</div>
    </div>
    
    <div style="line-height: 1.8;">
        <div><span class="data-label">Strumento (t):</span> <span id="t_val" class="data-value">...</span></div>
        <div><span class="data-label">Seriale (s):</span> <span id="s_val" class="data-value">...</span></div>
        <div><span class="data-label">Cliente (c):</span> <span id="c_val" class="data-value">...</span></div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
    
    <label><strong>Descrizione Problema (descr):</strong></label>
    <textarea id="descr" maxlength="256" rows="4" placeholder="Descrivi qui il malfunzionamento..."></textarea>
    
    <button onclick="salvaTicket()">INVIA SEGNALAZIONE</button>
</div>

<div style="max-width: 900px; margin: 20px auto;">
    <h3 style="color: #28a745; text-align: center;">Storico Segnalazioni</h3>
    <table id="logTable">
        <thead>
            <tr>
                <th>Data e Ora</th>
                <th>Cliente</th>
                <th>Strumento</th>
                <th>Seriale</th>
                <th>Descrizione</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    // Funzione per formattare Data e Ora
    function getNow() {
        const adesso = new Date();
        return adesso.toLocaleDateString('it-IT') + ' ' + adesso.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // Funzione per leggere i parametri URL
    function getCleanParam(name) {
        const results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results == null) return "N/A";
        return decodeURIComponent(results[1]) || "N/A";
    }

    // Caricamento variabili globali
    const cliente = getCleanParam('c');
    const strumento = getCleanParam('t');
    const seriale = getCleanParam('s');

    window.onload = function() {
        // Scriviamo i dati nella pagina
        document.getElementById('c_header').innerText = cliente;
        document.getElementById('c_val').innerText = cliente;
        document.getElementById('t_val').innerText = strumento;
        document.getElementById('s_val').innerText = seriale;
        
        // Scriviamo l'ora di accesso
        document.getElementById('access-time').innerText = "Accesso effettuato il: " + getNow();
    };

   const scriptURL = 'https://script.google.com/macros/s/AKfycbxEHjj28dF8AJ3qNFDMChGqgNMCv3wl5PgcM1LC2gltKMNj6uuSzDVfJi1dpIW3tmQAzg/exec';

function salvaTicket() {
    const descr = document.getElementById('descr').value.trim();
    if(!descr) return alert("Inserisci una descrizione");

    const oraSegnalazione = getNow();
    
    // Usiamo FormData per evitare problemi di permessi (CORS)
    const formData = new FormData();
    formData.append('dataOra', oraSegnalazione);
    formData.append('cliente', cliente);
    formData.append('strumento', strumento);
    formData.append('seriale', seriale);
    formData.append('descrizione', descr);

    // Mostriamo un messaggio di caricamento
    console.log("Invio in corso...");

    fetch(scriptURL, { 
        method: 'POST', 
        body: formData,
        mode: 'no-cors' // Fondamentale per Google Apps Script
    })
    .then(() => {
        alert("Segnalazione registrata!");
        aggiornaTabellaLocale(oraSegnalazione, descr);
        document.getElementById('descr').value = "";
    })
    .catch(error => {
        console.error('Errore!', error.message);
        alert("Errore di connessione. Riprova.");
    });
}

function aggiornaTabellaLocale(ora, d) {
    const tbody = document.querySelector("#logTable tbody");
    const row = tbody.insertRow(0);
    row.innerHTML = `<td>${ora}</td><td>${cliente}</td><td>${strumento}</td><td>${seriale}</td><td>${d}</td>`;
}
</script>

</body>
</html>



